name: Copiar carpeta (clientes)

on:
  workflow_dispatch:
    inputs:
      source_cliente:
        description: "Nombre carpeta origen dentro de /clientes (ej: acme)"
        required: true
        type: string
      dest_cliente:
        description: "Nombre carpeta destino dentro de /clientes (ej: acme2)"
        required: true
        type: string
      target_branch:
        description: "Branch destino (ej: main)"
        required: true
        default: "main"
        type: string
      overwrite:
        description: "Sobrescribir destino si existe"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: write

jobs:
  copy-folder:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (branch objetivo)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}

      - name: Validaciones
        shell: bash
        run: |
          set -euo pipefail

          BASE="clientes"
          SRC_NAME="${{ inputs.source_cliente }}"
          DST_NAME="${{ inputs.dest_cliente }}"
          OVERWRITE="${{ inputs.overwrite }}"

          # Normaliza (evita / al final)
          SRC_NAME="${SRC_NAME%/}"
          DST_NAME="${DST_NAME%/}"

          # Bloquea rutas raras tipo ../
          if [[ "$SRC_NAME" == *".."* || "$DST_NAME" == *".."* || "$SRC_NAME" == /* || "$DST_NAME" == /* ]]; then
            echo "❌ Nombres inválidos. Usá solo el nombre de carpeta (sin ../ ni rutas absolutas)."
            exit 1
          fi

          SRC="${BASE}/${SRC_NAME}"
          DST="${BASE}/${DST_NAME}"

          echo "SRC=$SRC"
          echo "DST=$DST"
          echo "OVERWRITE=$OVERWRITE"

          if [[ -z "$SRC_NAME" || -z "$DST_NAME" ]]; then
            echo "❌ source_cliente y dest_cliente no pueden estar vacíos"
            exit 1
          fi

          if [[ "$SRC" == "$DST" ]]; then
            echo "❌ Origen y destino deben ser diferentes"
            exit 1
          fi

          if [[ ! -d "$SRC" ]]; then
            echo "❌ No existe la carpeta origen: $SRC"
            echo "Contenido de /clientes:"
            ls -la "$BASE" || true
            exit 1
          fi

          if [[ -e "$DST" ]]; then
            if [[ "$OVERWRITE" == "true" ]]; then
              echo "⚠️ Destino existe. Se sobrescribe: $DST"
              rm -rf "$DST"
            else
              echo "❌ Destino ya existe y overwrite=false: $DST"
              exit 1
            fi
          fi

      - name: Copiar carpeta
        shell: bash
        run: |
          set -euo pipefail
          SRC="clientes/${{ inputs.source_cliente }}"; SRC="${SRC%/}"
          DST="clientes/${{ inputs.dest_cliente }}";   DST="${DST%/}"

          mkdir -p "$(dirname "$DST")"
          cp -R "$SRC" "$DST"

          - name: Commit & Push
        shell: bash
        run: |
          set -euo pipefail
          SRC="clientes/${{ inputs.source_cliente }}"; SRC="${SRC%/}"
          DST="clientes/${{ inputs.dest_cliente }}";   DST="${DST%/}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$DST"

          if git diff --cached --quiet; then
            echo "ℹ️ No hay cambios para commitear."
            exit 0
          fi

          git commit -m "Copia carpeta en clientes: $SRC -> $DST"
          git push origin "${{ inputs.target_branch }}"

